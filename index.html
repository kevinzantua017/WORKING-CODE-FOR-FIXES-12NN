<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LED-Board Optimization</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    /* Small additions for buttons & badges */
    .pill { display:inline-block; padding:2px 10px; border-radius:12px; font-weight:600; font-size:12px; }
    .pill.green { background:#e6fff0; color:#0a7; border:1px solid #0a7; }
    .pill.red   { background:#ffeaea; color:#c00; border:1px solid #c00; }
    .btn { padding:8px 12px; border-radius:6px; border:1px solid #ccc; background:#fff; cursor:pointer; }
    .btn:hover { background:#f6f6f6; }
    .btn-danger { border-color:#ff8a8a; background:#ffeaea; color:#b10000; }
    .btn-danger:hover { background:#ffdede; }
    .btn-primary { border-color:#0a7; color:#0a7; }
    .muted { color:#666; }
    .badges a { margin-right:12px; font-weight:700; text-decoration:none; }
    .badges .active { color:#0a7; }
    .badges .inactive { color:#c00; }
    .table-actions { margin-bottom:10px; display:flex; gap:8px; align-items:center; }
    .checkbox { width:18px; height:18px; }
  </style>
  <script defer src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
</head>
<body>

<header>
  <div class="header-container">
    <div class="logo"><img src="images/Adamson.png" alt="Logo"></div>
    <h1>LED-Board Optimization</h1>
    <nav>
      <a href="#" data-tab="dashboard" onclick="openTab('dashboard')" class="active">Dashboard</a>
      <a href="#" data-tab="analytics" onclick="openTab('analytics')">Analytics</a>
      <a href="#" data-tab="scenarios" onclick="openTab('scenarios')">Scenarios</a>
      <a href="#" data-tab="logs" onclick="openTab('logs')">Archive</a>
    </nav>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>
</header>

<div class="container active" id="dashboard">

  <h2>📡 Live Monitoring — Adamson University San Marcelino St.</h2>

  <div class="grid-dashboard">
    <div class="card">
      <h3>Pedestrian Camera</h3>
      <div class="camera-feed"><img id="camPed" alt="Pedestrian Camera" loading="eager"></div>
    </div>

    <div class="card">
      <h3>Vehicle Camera</h3>
      <div class="camera-feed"><img id="camVeh" alt="Vehicle Camera" loading="eager"></div>
    </div>

    <div class="card">
      <h3>Traffic Light Detector</h3>
      <div class="camera-feed"><img id="camTL" alt="Traffic Light Camera" loading="eager"></div>
    </div>
  </div>

  <div class="grid-2" style="margin-top:16px;">
    <!-- SYSTEM STATUS -->
    <div class="card">
      <h3>System Status</h3>
      <p><strong>System Status:</strong>
        <span id="sysStatus" class="pill red">OFFLINE</span>
      </p>
      <p class="muted" id="statusLine">
        TL: — | 🧍 0 | 🚗 0 | Nearest: 0.0 m | Speed: 0.0 m/s (0 km/h)
      </p>
    </div>

    <!-- SCENARIO PROGRAM -->
    <div class="card">
      <h3>Boards & Scenario</h3>
      <div class="badges" id="scenarioBadges">
        <a id="badgeVeh" class="inactive">Vehicle Priority</a>
        <a id="badgePed" class="inactive">Pedestrian Priority</a>
        <a id="badgeEmer" class="inactive">Emergency Vehicle</a>
      </div>
      <p style="margin-top:10px;">
        <strong>Current Light:</strong> <span id="currentLight" class="pill">—</span>
      </p>
      <p><strong>Current Decision:</strong> <span id="currentDecision" class="muted">—</span></p>
    </div>
  </div>
</div>

<!-- ================= ANALYTICS ================= -->
<div class="container" id="analytics">
  <h2>📊 Analytics</h2>
  <div class="grid-2">
    <div class="card" style="height:360px;">
      <h3>Vehicle & Pedestrian Density (last 10 minutes)</h3>
      <canvas id="densityChart"></canvas>
    </div>
    <div class="card" style="height:360px;">
      <h3>Decision Breakdown (GO/STOP/OFF)</h3>
      <canvas id="decisionChart"></canvas>
    </div>
  </div>
</div>

<!-- ================= SCENARIOS ================= -->
<div class="container" id="scenarios">
  <h2>🚦 Scenarios</h2>
  <p class="muted" id="ledBanner">LED Board: —</p>

  <div class="card scenario-card">
    <div class="scenario-header">
      <h3>Vehicle Priority</h3>
      <span id="scVeh" class="pill red">Offline</span>
    </div>
    <ul>
      <li><strong>Pedestrian Camera:</strong> 5–10 students waiting</li>
      <li><strong>Vehicle Camera:</strong> Heavy traffic 20+ Vehicles</li>
      <li><strong>Traffic Light:</strong> Red</li>
    </ul>
    <p><strong>YOLOv8 Action:</strong> Vehicles priority to ease congestion.
      LED: <em>“Vehicles Priority – Wait to Cross”</em></p>
  </div>

  <div class="card scenario-card">
    <div class="scenario-header">
      <h3>Pedestrian Priority</h3>
      <span id="scPed" class="pill red">Offline</span>
    </div>
    <ul>
      <li><strong>Pedestrian Camera:</strong> 30+ waiting</li>
      <li><strong>Vehicle Camera:</strong> 0–5 Vehicles</li>
      <li><strong>Traffic Light:</strong> Green</li>
    </ul>
    <p><strong>YOLOv8 Action:</strong> Prioritize pedestrians.
      LED: <em>“Prepare to Stop – Pedestrians Crossing”</em></p>
  </div>

  <div class="card scenario-card">
    <div class="scenario-header">
      <h3>Emergency Vehicle Detected</h3>
      <span id="scEmer" class="pill red">Offline</span>
    </div>
    <ul>
      <li><strong>Pedestrian Camera:</strong> ~20 waiting</li>
      <li><strong>Vehicle Camera:</strong> Ambulance with siren</li>
      <li><strong>Traffic Light:</strong> Yellow → Red</li>
    </ul>
    <p><strong>YOLOv8 Action:</strong> Override for ambulance right-of-way.
      LED: <em>“Emergency Vehicle Passing – Please Wait”</em></p>
  </div>
</div>

<!-- ================= ARCHIVE ================= -->
<div class="container" id="logs">
  <h2>🗂️ System Logs</h2>

  <div class="table-actions">
    <button class="btn" onclick="refreshArchive()">Refresh</button>
    <button class="btn btn-danger" onclick="clearAllLogs()">Clear All</button>
    <button class="btn" onclick="deleteSelected()">Delete Selected</button>
    <label style="margin-left:10px;"><input type="checkbox" class="checkbox" id="checkAll" onclick="toggleAll(this)"> Select All</label>
  </div>

  <div class="table-scroll">
    <table>
      <thead>
        <tr>
          <th></th>
          <th>Time</th>
          <th>Event</th>
          <th>LED-Board Status</th>
        </tr>
      </thead>
      <tbody id="archiveBody"></tbody>
    </table>
  </div>
</div>

<footer>
  <p>© 2025 Adamson University | AI-Driven LED Board Optimization</p>
</footer>

<script>
  // ======== CONFIG ========
  const BASE_URL = window.location.origin; // e.g., http://172.20.10.3:5000
  let onlineDeadline = 0; // for offline fallback

  function openTab(id) {
    document.querySelectorAll('.container').forEach(c=>c.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('header nav a').forEach(a=>{
      a.classList.toggle('active', a.getAttribute('data-tab')===id);
    });
    if (id === 'analytics') loadAnalytics();
    if (id === 'logs') refreshArchive();
  }

  function logout(){
    localStorage.removeItem("loggedInUser");
    location.reload();
  }

  // cameras
  window.addEventListener('load', ()=>{
    document.getElementById('camPed').src = BASE_URL + "/stream/ped";
    document.getElementById('camVeh').src = BASE_URL + "/stream/veh";
    document.getElementById('camTL').src  = BASE_URL + "/stream/tl";
  });

  // ======== SOCKET.IO ========
  const socket = io(BASE_URL + "/realtime", {transports:["websocket"]});

  function setSysOnline(isOnline){
    const el = document.getElementById('sysStatus');
    el.textContent = isOnline ? "ONLINE" : "OFFLINE";
    el.className = "pill " + (isOnline ? "green" : "red");
  }

  function scenarioBadgeUpdate(s) {
    const veh = document.getElementById('badgeVeh');
    const ped = document.getElementById('badgePed');
    const emr = document.getElementById('badgeEmer');

    veh.className = s.scenario === "scenario_2_rush_hold" ? "active" : "inactive";
    ped.className = s.scenario === "scenario_1_night_ped" ? "active" : "inactive";
    emr.className = s.scenario === "scenario_3_emergency" ? "active" : "inactive";

    veh.className += " " + (veh.className.includes("active") ? "" : "");
    ped.className += " " + (ped.className.includes("active") ? "" : "");
    emr.className += " " + (emr.className.includes("active") ? "" : "");

    veh.style.color = veh.className.includes("active") ? "#0a7" : "#c00";
    ped.style.color = ped.className.includes("active") ? "#0a7" : "#c00";
    emr.style.color = emr.className.includes("active") ? "#0a7" : "#c00";
  }

  function setLightBadge(color){
    const el = document.getElementById('currentLight');
    let cls = "pill";
    if (color === "green") cls += " green";
    if (color === "red")   cls += " red";
    el.className = cls;
    el.textContent = (color||'—').toUpperCase();
  }

  socket.on("status", (s)=>{
    // System status line (top-left card)
    const st = document.getElementById('statusLine');
    st.textContent = `TL: ${(s.tl_color||'—').toUpperCase()} | 🧍 ${s.ped_count} | 🚗 ${s.veh_count} | Nearest: ${Number(s.nearest_vehicle_distance_m).toFixed(1)} m | Speed: ${Number(s.avg_vehicle_speed_mps).toFixed(1)} m/s (${(Number(s.avg_vehicle_speed_mps)*3.6).toFixed(0)} km/h)`;

    // ONLINE immediately; set 5s offline fallback
    setSysOnline(true);
    onlineDeadline = Date.now() + 5000;

    // Scenario/boards card
    scenarioBadgeUpdate(s);
    setLightBadge(s.tl_color);
    document.getElementById('currentDecision').textContent =
      `${s.action || '—'}${s.scenario ? ' (' + s.scenario + ')' : ''}`;
  });

  // offline fallback ticker
  setInterval(()=>{
    if (Date.now() > onlineDeadline) setSysOnline(false);
  }, 500);

  // ======== ANALYTICS ========
  let densityChart, decisionChart, chartsReady=false;
  async function loadAnalytics(){
    if (chartsReady) return;
    const res = await fetch(BASE_URL + "/api/analytics");
    const rows = await res.json();
    const labels = rows.map(r=>r.minute);
    const ped = rows.map(r=>r.avg_ped);
    const veh = rows.map(r=>r.avg_veh);
    const go  = rows.map(r=>r.go);
    const st  = rows.map(r=>r.stop);
    const off = rows.map(r=>r.off);

    densityChart = new Chart(document.getElementById('densityChart'), {
      type:'bar',
      data:{labels,
        datasets:[
          {label:'Avg Pedestrians', data:ped},
          {label:'Avg Vehicles', data:veh},
        ]},
      options:{responsive:true, maintainAspectRatio:false}
    });

    decisionChart = new Chart(document.getElementById('decisionChart'), {
      type:'line',
      data:{labels,
        datasets:[
          {label:'GO', data:go},
          {label:'STOP', data:st},
          {label:'OFF', data:off},
        ]},
      options:{responsive:true, maintainAspectRatio:false}
    });
    chartsReady = true;
  }

  // ======== ARCHIVE (refresh / clear / delete selected) ========
  const bodyEl = document.getElementById('archiveBody');

  function renderRows(rows){
    bodyEl.innerHTML = "";
    for (const r of rows) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="checkbox" class="rowCheck checkbox" data-id="${r.id}"></td>
        <td>${new Date(r.ts*1000).toLocaleTimeString()}</td>
        <td>Ped: ${r.ped_count}, Veh: ${r.veh_count}, TL: ${(String(r.tl_color)||'').toUpperCase()}</td>
        <td>Vehicle: ${r.veh_led} | Pedestrian-L: ${r.ped_l_led} | Pedestrian-R: ${r.ped_r_led}</td>`;
      bodyEl.appendChild(tr);
    }
  }

  async function refreshArchive(){
    const res = await fetch(BASE_URL + "/api/logs?limit=200");
    const rows = await res.json();
    // ensure descending newest-first already, but reverse if needed:
    renderRows(rows);
  }

  async function clearAllLogs(){
    if (!confirm("Delete ALL log rows? This cannot be undone.")) return;
    const res = await fetch(BASE_URL + "/api/logs/clear", {method:"POST"});
    const ok = await res.json();
    if (ok && ok.ok) refreshArchive();
  }

  function toggleAll(master){
    document.querySelectorAll('.rowCheck').forEach(c=>c.checked=master.checked);
  }

  async function deleteSelected(){
    const ids = Array.from(document.querySelectorAll('.rowCheck:checked')).map(c=>Number(c.dataset.id));
    if (!ids.length) { alert("No rows selected."); return; }
    if (!confirm(`Delete ${ids.length} selected row(s)?`)) return;
    const res = await fetch(BASE_URL + "/api/logs/delete", {
      method:"POST",
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ids})
    });
    const ok = await res.json();
    if (ok && ok.ok) refreshArchive();
  }
</script>
</body>
</html>
